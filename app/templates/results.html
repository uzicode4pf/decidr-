<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vote - Decidr</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <nav class="bg-white shadow-sm">
        <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
            <a href="index.html" class="flex items-center space-x-2">
                <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center">
                    <span class="text-white font-bold text-xl">D</span>
                </div>
                <span class="text-2xl font-bold text-gray-800">Decidr</span>
            </a>
        </div>
    </nav>

    <div id="loadingState" class="max-w-2xl mx-auto px-4 py-12">
        <div class="bg-white rounded-2xl shadow-xl p-8 text-center">
            <div class="animate-pulse space-y-4">
                <div class="h-8 bg-gray-200 rounded w-3/4 mx-auto"></div>
                <div class="h-4 bg-gray-200 rounded w-1/2 mx-auto"></div>
                <div class="space-y-3 mt-8">
                    <div class="h-12 bg-gray-200 rounded"></div>
                    <div class="h-12 bg-gray-200 rounded"></div>
                    <div class="h-12 bg-gray-200 rounded"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="pollContent" class="hidden max-w-2xl mx-auto px-4 py-12">
        <div class="bg-white rounded-2xl shadow-xl p-8">
            <div class="mb-8">
                <div class="flex items-center justify-between mb-4">
                    <span id="pollTypeBadge" class="px-3 py-1 bg-indigo-100 text-indigo-700 text-sm font-semibold rounded-full">Simple Poll</span>
                    <span id="voteCount" class="text-sm text-gray-500">0 votes</span>
                </div>
                <h1 id="pollQuestion" class="text-3xl font-bold text-gray-900 mb-2"></h1>
                <p id="pollInstructions" class="text-gray-600">Click to select your choice</p>
            </div>

            <div id="simpleOptions" class="space-y-3 mb-8"></div>

            <div id="rankedOptions" class="hidden mb-8">
                <div class="bg-blue-50 border-2 border-blue-200 rounded-xl p-4 mb-4">
                    <p class="text-sm text-blue-800"><strong>Drag to rank</strong> your preferences from most to least preferred</p>
                </div>
                <div id="rankableList" class="space-y-3"></div>
            </div>

            <button id="submitVoteBtn" disabled class="w-full bg-indigo-600 text-white py-4 rounded-xl font-semibold text-lg hover:bg-indigo-700 transition transform hover:scale-[1.02] active:scale-[0.98] disabled:opacity-50 disabled:cursor-not-allowed">
                Submit Vote
            </button>
        </div>
    </div>

    <div id="alreadyVoted" class="hidden max-w-2xl mx-auto px-4 py-12">
        <div class="bg-white rounded-2xl shadow-xl p-8 text-center">
            <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                </svg>
            </div>
            <h2 class="text-2xl font-bold text-gray-900 mb-2">You've Already Voted!</h2>
            <p class="text-gray-600 mb-6">You can only vote once per poll</p>
            <a href="#" id="viewResultsBtn" class="inline-block bg-indigo-600 text-white px-8 py-3 rounded-xl font-semibold hover:bg-indigo-700 transition">View Results</a>
        </div>
    </div>

    <div id="successModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full">
            <div class="text-center">
                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                </div>
                <h2 class="text-2xl font-bold text-gray-900 mb-2">Vote Submitted!</h2>
                <p class="text-gray-600 mb-6">Thank you for participating</p>
                <div class="flex space-x-3">
                    <a id="modalViewResultsBtn" href="#" class="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-semibold hover:bg-indigo-700 transition text-center">View Results</a>
                    <button id="closeModalBtn" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl font-semibold hover:bg-gray-300 transition">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div id="notFound" class="hidden max-w-2xl mx-auto px-4 py-12">
        <div class="bg-white rounded-2xl shadow-xl p-8 text-center">
            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </div>
            <h2 class="text-2xl font-bold text-gray-900 mb-2">Poll Not Found</h2>
            <p class="text-gray-600 mb-6">This poll doesn't exist or has been deleted</p>
            <a href="index.html" class="inline-block bg-indigo-600 text-white px-8 py-3 rounded-xl font-semibold hover:bg-indigo-700 transition">Go Home</a>
        </div>
    </div>

    <script>
        // ============================================
        // ⚠️ CHANGE THIS: Your Backend API URL
        // ============================================
        const API_BASE_URL = 'http://localhost:8000';
        
        const urlParams = new URLSearchParams(window.location.search);
        const pollId = urlParams.get('id');
        let pollData = null;
        let selectedOption = null;

        function hasVoted(id) {
            return localStorage.getItem(`voted_${id}`) === 'true';
        }

        function markAsVoted(id) {
            localStorage.setItem(`voted_${id}`, 'true');
        }

        async function loadPoll() {
            if (!pollId) {
                showNotFound();
                return;
            }

            if (hasVoted(pollId)) {
                showAlreadyVoted();
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/polls/${pollId}`);
                if (!response.ok) throw new Error('Poll not found');
                pollData = await response.json();
                renderPoll();
            } catch (error) {
                console.error('Error:', error);
                showNotFound();
            }
        }

        function renderPoll() {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('pollContent').classList.remove('hidden');
            document.getElementById('pollQuestion').textContent = pollData.question;
            document.getElementById('voteCount').textContent = `${pollData.vote_count} votes`;
            
            if (pollData.type === 'simple') {
                renderSimplePoll();
            } else {
                renderRankedPoll();
            }
        }

        function renderSimplePoll() {
            document.getElementById('pollTypeBadge').textContent = 'Simple Poll';
            const container = document.getElementById('simpleOptions');
            container.innerHTML = '';

            pollData.options.forEach(option => {
                const div = document.createElement('div');
                div.className = 'option-btn border-2 border-gray-200 rounded-xl p-4 cursor-pointer hover:border-indigo-400 hover:bg-indigo-50 transition';
                div.dataset.id = option.id;
                div.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span class="font-medium text-gray-900">${option.text}</span>
                        <div class="w-6 h-6 border-2 border-gray-300 rounded-full flex items-center justify-center">
                            <div class="w-3 h-3 bg-indigo-600 rounded-full hidden check-circle"></div>
                        </div>
                    </div>
                `;
                div.addEventListener('click', () => selectSimpleOption(option.id, div));
                container.appendChild(div);
            });

            document.getElementById('simpleOptions').classList.remove('hidden');
            document.getElementById('rankedOptions').classList.add('hidden');
        }

        function selectSimpleOption(optionId, element) {
            document.querySelectorAll('.option-btn').forEach(btn => {
                btn.classList.remove('border-indigo-600', 'bg-indigo-50');
                btn.classList.add('border-gray-200');
                btn.querySelector('.check-circle').classList.add('hidden');
            });

            element.classList.remove('border-gray-200');
            element.classList.add('border-indigo-600', 'bg-indigo-50');
            element.querySelector('.check-circle').classList.remove('hidden');
            
            selectedOption = optionId;
            document.getElementById('submitVoteBtn').disabled = false;
        }

        function renderRankedPoll() {
            document.getElementById('pollTypeBadge').textContent = 'Ranked Choice';
            document.getElementById('pollInstructions').textContent = 'Drag to rank your preferences';
            
            const container = document.getElementById('rankableList');
            container.innerHTML = '';

            pollData.options.forEach((option, index) => {
                const div = document.createElement('div');
                div.className = 'rankable-item bg-white border-2 border-gray-200 rounded-xl p-4 cursor-move hover:border-indigo-400 transition';
                div.dataset.id = option.id;
                div.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="flex-shrink-0 w-8 h-8 bg-indigo-100 text-indigo-600 rounded-lg flex items-center justify-center font-bold rank-number">${index + 1}</div>
                        <span class="flex-1 font-medium text-gray-900">${option.text}</span>
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </div>
                `;
                container.appendChild(div);
            });

            new Sortable(container, {
                animation: 150,
                onEnd: updateRankNumbers
            });

            document.getElementById('simpleOptions').classList.add('hidden');
            document.getElementById('rankedOptions').classList.remove('hidden');
            document.getElementById('submitVoteBtn').disabled = false;
        }

        function updateRankNumbers() {
            const items = document.querySelectorAll('.rankable-item');
            items.forEach((item, index) => {
                item.querySelector('.rank-number').textContent = index + 1;
            });
        }

        document.getElementById('submitVoteBtn').addEventListener('click', async () => {
            const btn = document.getElementById('submitVoteBtn');
            btn.disabled = true;
            btn.textContent = 'Submitting...';

            try {
                let voteData;
                
                if (pollData.type === 'simple') {
                    voteData = { option_id: selectedOption };
                } else {
                    const items = document.querySelectorAll('.rankable-item');
                    voteData = {
                        rankings: Array.from(items).map((item, index) => ({
                            option_id: parseInt(item.dataset.id),
                            rank: index + 1
                        }))
                    };
                }

                const response = await fetch(`${API_BASE_URL}/api/polls/${pollId}/vote`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(voteData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to submit vote');
                }

                markAsVoted(pollId);
                const resultsUrl = `results.html?id=${pollId}`;
                document.getElementById('modalViewResultsBtn').href = resultsUrl;
                document.getElementById('successModal').classList.remove('hidden');

            } catch (error) {
                console.error('Error:', error);
                alert('Error submitting vote: ' + error.message);
                btn.disabled = false;
                btn.textContent = 'Submit Vote';
            }
        });

        document.getElementById('closeModalBtn').addEventListener('click', () => {
            document.getElementById('successModal').classList.add('hidden');
            if (pollData.settings.show_results) {
                window.location.href = `results.html?id=${pollId}`;
            } else {
                window.location.href = 'index.html';
            }
        });

        function showAlreadyVoted() {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('alreadyVoted').classList.remove('hidden');
            document.getElementById('viewResultsBtn').href = `results.html?id=${pollId}`;
        }

        function showNotFound() {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('notFound').classList.remove('hidden');
        }

        loadPoll();
    </script>
</body>
              </html>
