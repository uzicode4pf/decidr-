<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vote - Decidr</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm">
        <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
            <a href="index.html" class="flex items-center space-x-2">
                <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center">
                    <span class="text-white font-bold text-xl">D</span>
                </div>
                <span class="text-2xl font-bold text-gray-800">Decidr</span>
            </a>
        </div>
    </nav>

    <!-- Loading State -->
    <div id="loadingState" class="max-w-2xl mx-auto px-4 py-12">
        <div class="bg-white rounded-2xl shadow-xl p-8 text-center">
            <div class="animate-pulse space-y-4">
                <div class="h-8 bg-gray-200 rounded w-3/4 mx-auto"></div>
                <div class="h-4 bg-gray-200 rounded w-1/2 mx-auto"></div>
                <div class="space-y-3 mt-8">
                    <div class="h-12 bg-gray-200 rounded"></div>
                    <div class="h-12 bg-gray-200 rounded"></div>
                    <div class="h-12 bg-gray-200 rounded"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Poll Content -->
    <div id="pollContent" class="hidden max-w-2xl mx-auto px-4 py-12">
        <div class="bg-white rounded-2xl shadow-xl p-8">
            <!-- Poll Header -->
            <div class="mb-8">
                <div class="flex items-center justify-between mb-4">
                    <span id="pollTypeBadge" class="px-3 py-1 bg-indigo-100 text-indigo-700 text-sm font-semibold rounded-full">
                        Simple Poll
                    </span>
                    <span id="voteCount" class="text-sm text-gray-500">0 votes</span>
                </div>
                <h1 id="pollQuestion" class="text-3xl font-bold text-gray-900 mb-2">
                    Where should we eat dinner?
                </h1>
                <p id="pollInstructions" class="text-gray-600">
                    Click to select your choice
                </p>
            </div>

            <!-- Simple Poll Options -->
            <div id="simpleOptions" class="space-y-3 mb-8">
                <!-- Options will be inserted here -->
            </div>

            <!-- Ranked Choice Options -->
            <div id="rankedOptions" class="hidden mb-8">
                <div class="bg-blue-50 border-2 border-blue-200 rounded-xl p-4 mb-4">
                    <p class="text-sm text-blue-800">
                        <strong>Drag to rank</strong> your preferences from most to least preferred
                    </p>
                </div>
                <div id="rankableList" class="space-y-3">
                    <!-- Rankable options will be inserted here -->
                </div>
            </div>

            <!-- Submit Button -->
            <button id="submitVoteBtn" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-semibold text-lg hover:bg-indigo-700 transition transform hover:scale-[1.02] active:scale-[0.98] disabled:opacity-50 disabled:cursor-not-allowed">
                Submit Vote
            </button>

            <!-- View Results Link -->
            <div id="resultsLink" class="hidden mt-4 text-center">
                <a href="#" class="text-indigo-600 hover:text-indigo-700 font-medium">
                    View Results â†’
                </a>
            </div>
        </div>
    </div>

    <!-- Already Voted State -->
    <div id="alreadyVoted" class="hidden max-w-2xl mx-auto px-4 py-12">
        <div class="bg-white rounded-2xl shadow-xl p-8 text-center">
            <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                </svg>
            </div>
            <h2 class="text-2xl font-bold text-gray-900 mb-2">You've Already Voted!</h2>
            <p class="text-gray-600 mb-6">You can only vote once per poll</p>
            <a href="#" id="viewResultsBtn" class="inline-block bg-indigo-600 text-white px-8 py-3 rounded-xl font-semibold hover:bg-indigo-700 transition">
                View Results
            </a>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full relative">
            <!-- Confetti Animation -->
            <div class="absolute inset-0 pointer-events-none overflow-hidden">
                <div id="confetti" class="absolute inset-0"></div>
            </div>
            
            <div class="text-center relative z-10">
                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                </div>
                <h2 class="text-2xl font-bold text-gray-900 mb-2">Vote Submitted!</h2>
                <p class="text-gray-600 mb-6">Thank you for participating</p>
                
                <div class="flex space-x-3">
                    <a id="modalViewResultsBtn" href="#" class="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-semibold hover:bg-indigo-700 transition text-center">
                        View Results
                    </a>
                    <button id="closeModalBtn" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl font-semibold hover:bg-gray-300 transition">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Poll Not Found -->
    <div id="notFound" class="hidden max-w-2xl mx-auto px-4 py-12">
        <div class="bg-white rounded-2xl shadow-xl p-8 text-center">
            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </div>
            <h2 class="text-2xl font-bold text-gray-900 mb-2">Poll Not Found</h2>
            <p class="text-gray-600 mb-6">This poll doesn't exist or has been deleted</p>
            <a href="index.html" class="inline-block bg-indigo-600 text-white px-8 py-3 rounded-xl font-semibold hover:bg-indigo-700 transition">
                Go Home
            </a>
        </div>
    </div>

    <script>
        // Get poll ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const pollId = urlParams.get('id');

        // State
        let pollData = null;
        let selectedOption = null;
        let rankedOptions = [];

        // Elements
        const loadingState = document.getElementById('loadingState');
        const pollContent = document.getElementById('pollContent');
        const alreadyVoted = document.getElementById('alreadyVoted');
        const notFound = document.getElementById('notFound');
        const successModal = document.getElementById('successModal');

        // Check if user already voted (using localStorage for demo)
        function hasVoted(pollId) {
            const voted = localStorage.getItem(`voted_${pollId}`);
            return voted === 'true';
        }

        function markAsVoted(pollId) {
            localStorage.setItem(`voted_${pollId}`, 'true');
        }

        // Load poll data
        async function loadPoll() {
            if (!pollId) {
                showNotFound();
                return;
            }

            try {
                // TODO: Replace with actual API call
                // const response = await fetch(`/api/polls/${pollId}`);
                // pollData = await response.json();

                // Mock data for demo
                pollData = {
                    id: pollId,
                    question: "Where should we eat dinner?",
                    type: "simple", // or "ranked"
                    options: [
                        { id: 1, text: "Pizza Place" },
                        { id: 2, text: "Thai Restaurant" },
                        { id: 3, text: "Burger Joint" },
                        { id: 4, text: "Sushi Bar" }
                    ],
                    vote_count: 12,
                    settings: {
                        show_results: true
                    }
                };

                // Check if already voted
                if (hasVoted(pollId)) {
                    showAlreadyVoted();
                    return;
                }

                renderPoll();
            } catch (error) {
                console.error('Error loading poll:', error);
                showNotFound();
            }
        }

        function renderPoll() {
            loadingState.classList.add('hidden');
            pollContent.classList.remove('hidden');

            // Update header
            document.getElementById('pollQuestion').textContent = pollData.question;
            document.getElementById('voteCount').textContent = `${pollData.vote_count} votes`;
            
            if (pollData.type === 'simple') {
                renderSimplePoll();
            } else {
                renderRankedPoll();
            }
        }

        function renderSimplePoll() {
            document.getElementById('pollTypeBadge').textContent = 'Simple Poll';
            document.getElementById('pollInstructions').textContent = 'Click to select your choice';
            
            const container = document.getElementById('simpleOptions');
            container.innerHTML = '';

            pollData.options.forEach(option => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'option-btn border-2 border-gray-200 rounded-xl p-4 cursor-pointer hover:border-indigo-400 hover:bg-indigo-50 transition';
                optionDiv.dataset.id = option.id;
                optionDiv.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span class="font-medium text-gray-900">${option.text}</span>
                        <div class="w-6 h-6 border-2 border-gray-300 rounded-full flex items-center justify-center">
                            <div class="w-3 h-3 bg-indigo-600 rounded-full hidden check-circle"></div>
                        </div>
                    </div>
                `;
                
                optionDiv.addEventListener('click', () => selectSimpleOption(option.id, optionDiv));
                container.appendChild(optionDiv);
            });

            document.getElementById('simpleOptions').classList.remove('hidden');
            document.getElementById('rankedOptions').classList.add('hidden');
        }

        function selectSimpleOption(optionId, element) {
            // Deselect all
            document.querySelectorAll('.option-btn').forEach(btn => {
                btn.classList.remove('border-indigo-600', 'bg-indigo-50');
                btn.classList.add('border-gray-200');
                btn.querySelector('.check-circle').classList.add('hidden');
            });

            // Select clicked
            element.classList.remove('border-gray-200');
            element.classList.add('border-indigo-600', 'bg-indigo-50');
            element.querySelector('.check-circle').classList.remove('hidden');
            
            selectedOption = optionId;
            document.getElementById('submitVoteBtn').disabled = false;
        }

        function renderRankedPoll() {
            document.getElementById('pollTypeTag').textContent = 'Ranked Choice';
            document.getElementById('pollInstructions').textContent = 'Drag to rank your preferences';
            
            const container = document.getElementById('rankableList');
            container.innerHTML = '';

            pollData.options.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'rankable-item bg-white border-2 border-gray-200 rounded-xl p-4 cursor-move hover:border-indigo-400 transition';
                optionDiv.dataset.id = option.id;
                optionDiv.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="flex-shrink-0 w-8 h-8 bg-indigo-100 text-indigo-600 rounded-lg flex items-center justify-center font-bold rank-number">
                            ${index + 1}
                        </div>
                        <span class="flex-1 font-medium text-gray-900">${option.text}</span>
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </div>
                `;
                container.appendChild(optionDiv);
            });

            // Initialize Sortable
            new Sortable(container, {
                animation: 150,
                onEnd: updateRankNumbers
            });

            document.getElementById('simpleOptions').classList.add('hidden');
            document.getElementById('rankedOptions').classList.remove('hidden');
            document.getElementById('submitVoteBtn').disabled = false;
        }

        function updateRankNumbers() {
            const items = document.querySelectorAll('.rankable-item');
            items.forEach((item, index) => {
                item.querySelector('.rank-number').textContent = index + 1;
            });
        }

        // Submit vote
        document.getElementById('submitVoteBtn').addEventListener('click', async () => {
            const btn = document.getElementById('submitVoteBtn');
            btn.disabled = true;
            btn.textContent = 'Submitting...';

            try {
                let voteData;
                
                if (pollData.type === 'simple') {
                    voteData = { option_id: selectedOption };
                } else {
                    const items = document.querySelectorAll('.rankable-item');
                    voteData = {
                        rankings: Array.from(items).map((item, index) => ({
                            option_id: parseInt(item.dataset.id),
                            rank: index + 1
                        }))
                    };
                }

                // TODO: Replace with actual API call
                // await fetch(`/api/polls/${pollId}/vote`, {
                //     method: 'POST',
                //     headers: { 'Content-Type': 'application/json' },
                //     body: JSON.stringify(voteData)
                // });

                // Mark as voted
                markAsVoted(pollId);

                // Show success
                successModal.classList.remove('hidden');
                createConfetti();

                // Update links
                const resultsUrl = `results.html?id=${pollId}`;
                document.getElementById('modalViewResultsBtn').href = resultsUrl;
                document.querySelectorAll('#resultsLink a, #viewResultsBtn').forEach(link => {
                    link.href = resultsUrl;
                });

            } catch (error) {
                console.error('Error submitting vote:', error);
                alert('Error submitting vote. Please try again.');
                btn.disabled = false;
                btn.textContent = 'Submit Vote';
            }
        });

        // Close modal
        document.getElementById('closeModalBtn').addEventListener('click', () => {
            successModal.classList.add('hidden');
            if (pollData.settings.show_results) {
                window.location.href = `results.html?id=${pollId}`;
            } else {
                window.location.href = 'index.html';
            }
        });

        // Show states
        function showAlreadyVoted() {
            loadingState.classList.add('hidden');
            alreadyVoted.classList.remove('hidden');
            const resultsUrl = `results.html?id=${pollId}`;
            document.getElementById('viewResultsBtn').href = resultsUrl;
        }

        function showNotFound() {
            loadingState.classList.add('hidden');
            notFound.classList.remove('hidden');
        }

        // Confetti effect
        function createConfetti() {
            const confettiContainer = document.getElementById('confetti');
            const colors = ['#6366f1', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981'];
            
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.style.position = 'absolute';
                confetti.style.width = '10px';
                confetti.style.height = '10px';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.top = '-10px';
                confetti.style.opacity = '1';
                confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                confetti.style.transition = 'all 3s ease-out';
                
                confettiContainer.appendChild(confetti);
                
                setTimeout(() => {
                    confetti.style.top = '100%';
                    confetti.style.opacity = '0';
                    confetti.style.transform = `rotate(${Math.random() * 720}deg)`;
                }, 100);
                
                setTimeout(() => confetti.remove(), 3100);
            }
        }

        // Initialize
        loadPoll();
    </script>
</body>
              </html>
